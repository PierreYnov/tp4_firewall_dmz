# TP4 : Utilisation avancé du filtrage de paquets réseaux
## Construction d’une DMZ complexe


![](https://i.gyazo.com/ffacc0d9f17f25c05104f4333be5885a.png)


# Sommaire

- [Serveur Web](##serveur-web)
    - [I. Installation de Apache](###i-installation-de-apache)
    - [II. Installation de Wordpress](###ii-installation-de-wordpress)
    - [III. Iptables](###iii-iptables)
- [Serveur Base de données](##Serveur-base-de-données)
    - [I. Installation du serveur MySQL](###i-installation-du-serveur-mysql)
    - [II. Création de la base de données Wordpress](###ii-création-de-la-base-de-données-wordpress)
    - [III. Nftables](###iii-nftables)
- [Firewall pfSense frontal](##Firewall-pfSense-frontal)
- [Firewall pfSense back](#firewall-pfsense-back)
- [Démonstration](##Démonstration)

## Serveur Web

OS : Centos 7 (Réseau Privé Hôte pour avoir l'IP fixe, qu'on reconfigure aussi dans ``/etc/sysconfig/network-scripts/ifcfg-enp0s8``)

```
NAME=enp0s8
DEVICE=enp0s8

ONBOOT=yes
BOOTPROTO=static

IPADDR=192.168.33.2
NETMASK=255.255.255.0

NETWORK=192.168.33.0
GATEWAY=192.168.33.254
```

###  I. Installation de Apache

```
sudo yum install httpd
```

Ensuite on peut démarrer le serveur httpd :

```
sudo systemctl start httpd
sudo systemctl enable httpd
```
On peut vérifier son statut :

![](img/httpd.png)

Le service est bien **démarré**. Il suffit de se rendre sur internet pour vérifier notre page en allant sur l'adresse IP de notre machine : http://192.168.33.2

![](img/page_apache.png)

### II. Installation de Wordpress

Pour l'installation de Wordpress, il faut avoir préalablement PHP d'installé avec une version **supérieure à 5.6** pour que ce soit fonctionnel.

- Téléchargement et installation de Wordpress :

```
cd ~
wget http://wordpress.org/latest.tar.gz
tar xzvf latest.tar.gz
sudo rsync -avP ~/wordpress/ /var/www/html/
mkdir /var/www/html/wp-content/uploads
sudo chown -R apache:apache /var/www/html/*
```

- Configuration de la base de donnée pour Wordpress :

```
cd /var/www/html    
cp wp-config-sample.php wp-config.php
vim wp-config.php
```

Fichier de configuration (à remplacer par les informations correspondantes):

![](img/wpconfig.png)

Apache ne lit pas les fichiers PHP par défaut, donc dans le fichier (``vi /etc/httpd/conf/httpd.conf``), il faut ajouter à ``Directory index`` :

``index.php``

On redémarre le serveur ``httpd`` (``sudo service httpd restart``), et on remarque que le Wordpress est mis en place.


### III. Iptables

#### Désactiver FirewallD

    sudo systemctl stop firewalld
    sudo systemctl disable firewalld
    sudo systemctl mask --now firewalld

#### Installation et Activation de Iptables

    sudo yum install iptables-services
    sudo systemctl start iptables
    sudo systemctl start ip6tables
    sudo systemctl enable iptables
    sudo systemctl enable ip6tables

#### Check du service & des règles appliquées

    sudo systemctl status iptables
    sudo iptables -nvL

#### Filtrage Iptables

On ajoute ces lignes dans le fichier ``/etc/sysconfig/iptables``

```
# Generated by iptables-save v1.4.21 on Fri Nov 13 22:19:31 2020
*mangle
:PREROUTING ACCEPT [429:38165]
:INPUT ACCEPT [429:38165]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [300:46319]
:POSTROUTING ACCEPT [282:45065]
COMMIT
# Completed on Fri Nov 13 22:19:31 2020
# Generated by iptables-save v1.4.21 on Fri Nov 13 22:19:31 2020
*nat
:PREROUTING ACCEPT [3:716]
:INPUT ACCEPT [1:60]
:OUTPUT ACCEPT [18:1254]
:POSTROUTING ACCEPT [0:0]
COMMIT
# Completed on Fri Nov 13 22:19:31 2020
# Generated by iptables-save v1.4.21 on Fri Nov 13 22:19:31 2020
#
# Politique par défault
*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT DROP [0:0]

# SSH
-A INPUT -p tcp -m tcp --dport 22 -m conntrack --ctstate NEW,ESTABLISHED -j ACCEPT
-A OUTPUT -p tcp -m tcp --sport 22 -m conntrack --ctstate ESTABLISHED -j ACCEPT

# HTTP / HTTPS
-A INPUT -p tcp -m multiport --dports 80,443 -m conntrack --ctstate NEW,ESTABLISHED -j ACCEPT
-A INPUT -p tcp -m multiport --sports 80,443 -m conntrack --ctstate NEW,RELATED,ESTABLISHED -j ACCEPT
-A OUTPUT -p tcp -m multiport --dports 80,443 -m conntrack --ctstate NEW,RELATED,ESTABLISHED -j ACCEPT
-A OUTPUT -p tcp -m multiport --sports 80,443 -m conntrack --ctstate NEW,RELATED,ESTABLISHED -j ACCEPT

# DNS
-A INPUT -p udp -m udp --sport 53 -m conntrack --ctstate NEW,RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p tcp -m tcp --sport 53 -m conntrack --ctstate NEW,RELATED,ESTABLISHED -j ACCEPT
-A OUTPUT -p udp -m udp --dport 53 -m conntrack --ctstate NEW,RELATED,ESTABLISHED -j ACCEPT
-A OUTPUT -p tcp -m tcp --dport 53 -m conntrack --ctstate NEW,RELATED,ESTABLISHED -j ACCEPT

# ICMP
-A INPUT -p icmp -j ACCEPT
-A  OUTPUT -p icmp -j ACCEPT

# Mysql
-A INPUT -s 192.168.35.4/24 -p tcp -m tcp --sport 3306 -m conntrack --ctstate NEW,RELATED,ESTABLISHED -j ACCEPT
-A OUTPUT -d 192.168.35.4/24 -p tcp -m tcp --dport 3306 -m conntrack --ctstate NEW,RELATED,ESTABLISHED -j ACCEPT

COMMIT
# Completed on Fri Nov 13 22:19:31 2020

```

> Nous n'avons pas définis d'adresse IP sur les iptables surtout sur le ping ICMP car l'encapsulation réseau entre les deux firewalls pfsense change l'adresse. Donc nous avons autorisé le flux icmp sur les iptables mais sur le firewall pfsense, nous avons mis une restriction par IP.

Sauvegarder puis

    sudo service iptables restart

Pour check

    sudo iptables -L

## Serveur base de données

Le serveur de base de données devra être positionné sur un réseau dédié comme indiqué sur le schéma, et disposer d’une adresse IP fixe. Il fonctionnera sous **Centos 8**, et hébergera via un serveur **MySQL** la base de données du site Wordpress.

```
NAME=enp0s8
DEVICE=enp0s8

ONBOOT=yes
BOOTPROTO=static

IPADDR=192.168.35.4
NETMASK=255.255.255.0

NETWORK=192.168.35.0
GATEWAY=192.168.35.254
```

### I. Installation du serveur MySQL

```
sudo dnf install mysql-server
sudo systemctl start mysqld.service
sudo systemctl enable mysqld.service
```

On peut vérifier ensuite l'installation :

![](img/mysql-server.png)



### II. Création de la base de données Wordpress

```
CREATE DATABASE wordpress;
```

- Création d'un utilisateur ``wordpressuser`` et ajout de privilèges :

```
CREATE USER 'wordpressuser'@'localhost' IDENTIFIED BY 'toortoor';
GRANT ALL PRIVILEGES ON wordpress. * TO 'wordpressuser'@'localhost';
FLUSH PRIVILEGES;
```

- Ajoutez l'utilisateur avec l'adresse de ``remote`` :

```
CREATE USER 'wordpressuser'@'192.168.33.2' IDENTIFIED BY 'toortoor';
GRANT ALL PRIVILEGES ON wordpress. * TO 'wordpressuser'@'192.168.33.2';
FLUSH PRIVILEGES;
```

- Puis dans ``/etc/my.cnf``, on ajoute le ``bind adrress`` (l'ip de notre database):

```
bind-address=192.168.35.4
```

### III. Nftables

#### Désactivation de FirewallD

    sudo systemctl disable --now firewalld
    sudo systemctl mask firewalld
    reboot

#### Mise en place du Filtrage

On va dans ``/etc/sysconfig/nftables.conf`` et on met

```
table inet filter {
       chain input {
               type filter hook input priority 0;
               iifname lo accept;
               tcp dport 80 accept;
               tcp dport 443 accept;
               tcp dport 53 accept;
               udp dport 53 accept;
               tcp dport 3306 ip saddr 192.168.33.2/24 accept;
               ip protocol icmp accept;
               tcp dport 22 accept;
               policy drop;
       }
       chain forward {
               type filter hook forward priority 0;
               policy drop;
       }
       chain output {
               type filter hook output priority 0;
               tcp sport 80 accept;
               tcp sport 443 accept;
               tcp sport 53 accept;
               udp sport 53 accept;
               ip protocol icmp accept;
               tcp sport 3306 ip daddr 192.168.33.2/24 accept;
               tcp sport 22 accept;
               policy drop;
       }
}
```

> Nous n'avons pas définis d'adresse IP sur les iptables surtout sur le ping ICMP car l'encapsulation réseau entre les deux firewalls pfsense change l'adresse. Donc nous avons autorisé le flux icmp sur les iptables mais sur le firewall pfsense, nous avons mis une restriction par IP.

On a plus qu'à :

    systemctl enable nftables.service
    reboot

## Firewall pfSense frontal

Installation classique de pfSense puis on configure sur le panel Web les interfaces du serveur BDD et Web.

Récapitulatif Ip :

|   Interface   |        IP       |
| ------------- |  -------------  |
|     WAN       |    10.0.2.15    |
|     LAN       |  192.168.56.56  |
|  Server web   | 192.168.33.254  |
|  Server bdd   | 192.168.35.254  |

> La WAN est un DHCP du réseau NAT créer dans virtualbox.

Ensuite, nous avons configuré les DNS :

![](img/dns.png)

Pour relier les interfaces aux vms, on a donc mis en IP des interface leur gateway.

![](img/pfsense_interface.png)

La gateway par défault du réseau NAT c'est ajouté par défault dans le pfsense.

![](img/gw_nat.png)

Les règles WAN et LAN sont celles par défault.

Les règles sur le serveur Web :

![](img/rule_web.png)

Les règles sur le serveur de BDD :

![](img/rule_bdd.png)

## Firewall pfSense back

Installation classique de pfSense puis on configure sur le panel Web les interfaces du poste de travail et des informaticiens.

Récapitulatif Ip :

|   Interface   |        IP       |
| ------------- | -------------   |
|     WAN       |    10.0.2.4     |
|     LAN       |  192.168.56.11  |
|  Poste info   | 192.168.211.254 |
| Poste travail | 192.168.215.254 |

> La WAN est un DHCP du réseau NAT créer dans virtualbox, le même que le pfsense frontal.

Ensuite, comme sur le pfsense frontal, nous avons configuré les DNS :

![](img/dns.png)

Pour relier les interfaces aux vms, on a donc mis en IP des interface leur gateway.

![](img/pfsense_inter2.png)

La gateway par défault du réseau NAT c'est ajouté par défault dans le pfsense.

![](img/gw_nat.png)

Les règles sur les postes de travail :

![](img/rule_travail.png)

Les règles sur les informaticiens :

![](img/rule_info.png)

## Démonstration

Le serveur Web peut se connecter à MySql sur le serveur base de données après la mise en place des règles de filtrage :

* via cli :

![](img/bdd_OK.png)

* via interface web :

![](img/web_ok.png)

Les informaticiens peuvent ping le serveur web et la base de données :

* Informaticiens ping vers serveur web :

![](img/ping_info_web.png)

* Informaticiens ping vers base de données :

![](img/ping_info_bdd.png)

Les informaticiens peuvent se connecter en SSH au serveur web et la base de données :

* Informaticiens ssh vers serveur web :

![](img/ssh_info_web.png)

* Informaticiens ssh vers base de données :

![](img/ssh_info_bdd.png)

Les informaticiens peuvent consulter le site web :

![](img/curl_info.png)

Les informaticiens peuvent accèder au webgui des pfsenses :

* pfsense back : OK
* pfsense front : NON
